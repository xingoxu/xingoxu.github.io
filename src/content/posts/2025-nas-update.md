---
title: 论垃圾佬的养成，一次 NAS 硬件升级与客厅电脑的升级的流水账
published: 2025-11-28
description: '自 2020 年自组了 NAS 之后，2025 年 4 月份的某天下午，进行一个非常常规的寻找文件，双击文件准备打开某个 pdf 的时候，嗝愣一下，等了十几秒文件都没法打开，直到半分钟后，邮箱里传进来了几封报警邮件，一开发现掉盘了，而且仔细一看，好几封邮件，一掉还掉俩硬盘，心想我擦……这下坏事儿了。'
# image: ''
tags:
  - notes
# category: ''
draft: true
---

## 起因

自 2020 年自组了 NAS 之后，2025 年 4 月份的某天下午，进行一个非常常规的寻找文件，双击文件准备打开某个 pdf 的时候，嗝愣一下，等了十几秒文件都没法打开，直到半分钟后，邮箱里传进来了几封报警邮件，一开发现掉盘了，而且仔细一看，好几封邮件，一掉还掉俩硬盘，心想我擦……这下坏事儿了。

情况可算是惨烈，自己组装的这台 NAS 用的是 xfs 的文件系统，在网上找恢复数据教程也啥都没出来，只有两个官方命令，先脱机然后挂载到 debian 下，然后 xfs_repair，这也就决定了要么硬盘全好，要么硬盘全毁。

其中一块硬盘好像没什么问题只是引导区掉了貌似，几秒就正常了，另一块就没那么好运了，提示无法修复，于是强行恢复后把磁盘上那些个扫出来的文件全部都拉到了 lost+found，结果还得一个一个去看文件内容才能知道是什么，才能进行恢复。

## 背景以及第一代自组 NAS

技术选型的时候倒也没想那么多，2020 年也是一次事故导致的想自组 NAS 的念头。在 2020 年前都是用的群晖 916，四盘位+x86 架构，能跑 docker 能跑一点点虚拟机其实也已经很满足了，但也有很多问题吧，一个是 nas 方面只起到了一个下载和分享文件的作用，硬解可以用自带的 video station 和 ffmpeg，但除此之外全是 cpu 软解，相当的卡（可能可以，当然也是我之前不会用来着）,另一个是运算上，我有一些用 headless chrome 的爬虫脚本，可以正常跑，速度很慢，也算能用，但每次升级 chrome 就会是非常头疼的一件事，以及跑 PT，因为怕日本的家宽版权原因，不敢直接挂 PT，所以我通了一层 wireguard 去做种，然而如果不小心把 image 给删了，很有可能要对里边的内容进行重新编译。

![旧DS916](https://staticimg-v2.xingoxu.com/image/680439e5-f547-44df-ba32-42df7fbe27c2.jpg)

当然以上是不满的源头，导火索是我在新冠的时候买了一个 2.5G 的 USB 网卡，稍微整了一下驱动就在群晖上跑起来了，结果在两个月回国的期间，离回日本还有一个月的时间点上，手贱点了一下自带的网卡驱动升级…………于是，NAS 失联了…………在剩下的那一个月里疯狂去看各种自组 NAS 的代餐，

也是第一台自组 NAS 的由来，那同样两三千块我可以买一台更好的配置干嘛还用群晖啊反正我也就用那几个功能，其他的现有的系统也是点点点就解决了的事情。

### 硬件方案

第一代 NAS 的硬件选型是当时 2020 年比较乞丐的，

```
CPU: QSRL（Intel 10100T）
主板: asrock B460M
PCIE1: hp 561 flr拆机10G网卡
PCIE2: IT卡HBA模式直通卡
机箱: 用的 TANK 的那个小洋房，自带散热解决方案
内存: pdd买的寨条16g ddr4 x 2
电源: 益恒 250W 小1u

```

具体价格可能记不太清了，除了那个机箱 850 前后以外，内存大概 400 一根？，益恒电源大概是 270，因为收的也都是二手，整套也就 3000 吧应该。

![第一代自组NAS成品图](https://staticimg-v2.xingoxu.com/image/7019a572-76e3-496a-a51a-cc89c65c5d82.jpg)

当然组装第一台 NAS 中也有一些小插曲，比如闲鱼上收的便宜电源结果点不亮到电脑城帮忙调试一下确定是电源问题不是主板和 u 问题，收的第二台益恒电源发现线太短以及少 4pin 口子还是 sata 口子？（忘了）

转接线到货时间会比较长于是索性直接买了一台全新的反正也就 300 不到，点亮无问题之后带到日本后又发现装系统定时死机。最后跑内存测试连续跑两遍才出内存问题之后在日本也没办法退随即在日本煤炉上倒出去了（论我干过的缺德事，只能说 windows 比较强大吧内存有问题也能正常跑，所以这种寨条到底是谁在买）

![第一代NAS](https://staticimg-v2.xingoxu.com/image/0c21b411-cfc2-4340-a202-bb837de4ac0b.jpg)

所以中间也是有了很多的装机经验，比如内存不可以在拼多多买，就算买了也得连续跑两次内存压力测试。但也比较有意思的，在闲鱼上买的一个 SAS 8T 硬盘居然到现在还没挂，一直把他当垃圾处理所以放在下载池跑 PT 结果到现在也有 6 年了，之前就已经十万小时的通电时间了寿命也太长了……

当然今天回过头来看这些其实交了不少学费，还是不够垃圾佬。

### 软件方案

也算是看哔哩哔哩的 up 主们的抄作业吧，试了之后发现确实这样做很好也很符合自身需求，就是底层装 pve，然后开虚拟机装 nas 系统加直通硬件，这样的话其他虚拟机的运算任务基本不会妨碍 nas 自身的问题，nas 自己的任务就放在自己的机器里运行。

我并没有完全分离比如 nfs 或者 smb 拉出来然后在其他虚拟机上进行一个再加工这样，我还是会觉得有延时很怕文件会有 conflict，另一个是对性能上还是有一道心理过不去的坎，会觉得同一个主机上的文件我为什么要再走一遍网络层在那边加工的感觉好傻。

当然也在 nas 自己上不能解决的事情还是会分开来这样，比如另一个录制电视的 mirakurun 我就单开虚拟机的，他那个 recdvb 的编译莫名其妙就是 ubuntu 下能过，好多 debian 的系统也过不了，因为 debian 默认没开某些参数编译。结果 nas 的系统还是有这样那样的限制，那也是现在多虚拟机方案的好处。

nas 系统上选择的是 omv，起初一开始选择的是网红 NAS 系统 unraid，最终没有选择它的原因当然不是价格问题，当时才卖 99 人民币终生。当然定价问题是我对 unraid 这个东西将来发展的存疑之一，现在来看他已经回归正常定价还蛮 make sense，当时我对他的感受是诶有缓存池，有自动搬运缓存功能，然后文件是分散分布的，加上一个看起来挺合理的一个校验池，那么最后不采用 unraid 的理由还是那个采用的小众的 linux 版本，而不是用的人多的 debian 或者 fedora 系，又是闭源的，那如果驱动装不上，或者报错了，我又没办法知道是我的问题，还是驱动的问题，还是系统的问题。[事实上在 pve 下的 6.11+的 unraid 就没有办法使用 uhd 630 分出来的 vgpu](https://forums.unraid.net/topic/129315-unraid-611-freeze-with-i915-gpu-passthrough-on-proxmox/)，开机死机（之后有没有解决不是很清楚）。 那么我觉得最终结果就是还是会重蹈群辉的覆辙。

omv 这个系统上手后其实也就是个带图形界面的 debian 吧，正好卡在我的好球区，我对 smb/nfs 共享，以及一些杂七杂八的小命令记得不是很熟，那 nfs 正好把那些都帮我做了图形界面，而那些我自定义的脚本 docker 容器等等又能很方便的去自己使用命令行启动。

最后最后采用的硬盘方案是 mergerfs，无校验。我当时自己觉得，我的重要文件都做了同步，每台电脑上都有一份不需要额外再进行备份，剩下的那些丢了可能也一辈子不会再 review 了吧，又能充分利用各种容量的硬盘挺好的。

### 对第一代 NAS 方案的反思

很多事情不试过不发生也是一辈子不知道，包括网上搜也不知道怎么搜出来。

比如 pve 或者其他的一些直通硬盘，PCIe 可以单独通，但是直连主板的那几个 SATA 口子是一起直通（能读到 SMART 的那种直通，也就是SATA控制器）的而不是一个口子一个口子通的，所以在策划硬件的时候也要想好自己的 nas 定位和使用分配。

又比如这次 xfs 文件系统挂了之后才觉得嗯，要找那些用的人多的，恢复数据教程或者就要做冗余的，至少要设想一下如果硬盘炸了是要一个怎样的操作方法去解决硬盘问题。以及也让我真正认识到了说辛辛苦苦收藏的那么多人类文明一旦某一天消失了，那也是找不回来的。
**特别特别是 mergerfs 这个文件系统**，上手时你觉得感觉硬盘均匀用的恰到好处，可以混合使用不同大小的硬盘，结果炸了一个的时候没有备份就只能看空文件夹在那边哭，或者 1.jpg，3.jpg，4.jpg 而没有 2.jpg 的那种空虚感。

### 掉盘后续

你很关心盘掉了之后我是怎么处理的吧以及那个坏掉的盘到底是什么情况吧。

怎么处理当然是一个文件一个文件看过去然后再把他们放回原来的位置 & 如果没有了就没有了咯。如果我知道哪些是没有了的，有些还能重新下的话就重新下了，最恐怖的是不知道什么文件掉了。那就，让他走吧。

关于原因其实我自己也不是很清楚，后来把丢失文件复制到其他硬盘上后我就把盘拿下来全盘扫描了结果是全部绿块没有坏道，SMART 就更是完全没有问题

唯一稍微有点可能性的是我的这套设备长时间（超过 5 个小时）运行后，就很有可能会发生无法关机的问题，无论是 pve 系统下还是 windows 下都有发生过，我开着 pve 的 log 查看后发现系统已经发出了 ACPI PowerOff 的指令但最后就卡在那边没有关机，另外在发出关机指令之前最后提示无法卸载/dev/的某个设备，给 chatGPT 分析了说是无伤大雅不会影响关机因为最后已经发出了 ACPI 关机指令了。

这个无法关机的问题还没查明白，那边为啥硬盘会炸也不明白。可能是让磁头没有正常归位的原因导致引导区或者寻道的一些这样那样的问题？如果你知道原因欢迎跟我联系。

不过反正不是 CPU 就是主板，就是直通卡或者 561flr 问题咯？（？都猜了个遍）另外这块炸了的硬盘格式化之后被我放到作为第二代 NAS 方案的冷备用了。

## 第二代 NAS 方案

然后就很巧的是硬盘坏了之后的几个月之后的某一天忘了哪个平台给我推了个 epyc 7d12 的帖子还是视频吧（也有可能是我手贱自己搜的）

感觉很香啊服务器板 U 整套加起来也就 5000？正愁感觉原来的NAS拓展性比较差，这次性能拓展一次拉满。嗨没想到大船过海又过海，过完太平洋还得过日本海，于是说搞就搞。

### 硬件配置

硬件就直接抄的几个帖子的，我这边也贴一下自己的配置

```
CPU: EPYC 7D12
主板：SuperMicro H11SSL-i
内存：三星 16G * 4 DDR4 REG ECC
散热：金钱豹SP3
电源：长城巨龙 1200W
机箱：追风者 614
显卡：NVIDIA P4

```

当然因为是要保证在数据迁移过程中原本的那些脚本也要持续运行（我也是要上班的），所以还是又买了一个直通卡 + 561flr 网卡。

整套设备真的是可聊的太多了，首先大家可以去参阅一些我当时看的帖子 ↓

> [12盘位NAS机箱和AMD EPYC大船靠岸之存储整合方案](https://www.chiphell.com/thread-2509428-1-1.html)  
> [ALL IN ONE NAS 主机升级小记-2025](https://www.azimiao.com/11448.html)  
> [EPYC7D12 8盘3.5寸机械+多盘nvme闪存 【25G高性能】 NAS搭建方案分享](https://www.zhihu.com/tardis/bd/art/644202809)  
> [数框框狂喜，AMD 霄龙 EPYC 7D12 捡垃圾](https://lishuma.com/archives/5501)  
> [家庭服务器Step ZERO to ONE](https://xinalin.com/65/homeserver-step-zero-to-one) 这个是 7542，但为了了解 H11 这个主板也参照了这个

首先这套设备除了显卡和 PCIe 设备是找 js 买的整机，整套 4500 出头一点。之后替换成淘宝图。看了上边的几个帖子里说 7D12 因为是 OEM 的流出所以 H11 的某几个 BIOS rev 没法点亮什么的，那想着要是自己买没法确认点亮的情况下也没法退就比较麻烦了。那花点辛苦费让人帮忙装机 + 确认也不算贵了。

托朋友旅游从国内托运带到日本来，然后我去机场接机带回家的。你问我为啥不在日本买，那日本人又没有流出这些东西的途径也不收垃圾啊……其次是淘宝过境的话过关是个大问题，我也不是很想拆盲盒，万一被退了或者收了高额关税那也不是我们垃圾乞丐的作风了。

其次是店家装机确实点亮了，因为没有买硬盘所以店家进了BIOS拍了张图给我就当是点亮了。

我一开箱发现 reset 键没法用，然后风扇有个没转，然后装了 windows 测机发现 64G 只点亮了 32G。

嘛本身也是要加风扇和硬盘的，于是把线全理了才发现这神装机。

然后之最后，我又把所有的配置都换了一遍笑死。

首先是内存点亮问题，几个帖子也说了 7D12 是特殊 U 只能点外边两个，然后 js 给我装的是里边两个，嗨 BIOS 里正常显示进了系统就直接只有一半了。骚操作还有把那个风扇集线器自己插上自己，倒是妹短路。也是服了。

然后就是整套设备开起来，哇靠那~~呻吟~~声音震耳欲聋，就最低转速已经身如机房，嗡嗡嗡的。
金钱豹这个暴力风扇，转速也太高了，我估计店家主卖那些二手组装服务器给那些实验室做流体运算的，结果我要求改个 7D12 也是不知道其实是个 100W 都不到的 U。

开始只是想把这个风扇改成不那么静音的，也不知道有啥牌子的风扇是比较安静的，看那个形状还以为那个风扇是弯的好像换不了，直接找淘宝上卖 noctua 店家寻思问问啥大小的能换上去，店家直接给我推荐散热器了，店主真的很会做生意上来先说原价 500 多给我直接优惠 8 折，我网上一查发现啊确实比日本免税 and 其他淘宝店标价也要低，正好也有朋友要回一趟上海就一冲动直接买了。事实上后来我拆散热的时候就发现那风扇其实可以单独换，也就普通 12025 风扇。

换完了暴力风扇，就是整 P4 的散热问题，淘宝上买的 3D 侧吹的模具不用附赠的暴力风扇就算是 noctua 满速也是压不了 P4 的满载，于是只好把盖板拆了拿了两个 6025 风扇在那吹，那这样单槽卡就变成了双槽的厚度了，也是为了静音要做出的牺牲。

最后都整完了发现电源的声音比较大了，主要是空载室温 26 度时会有中频到高频的持续性的电流声，偶尔会伴有风扇刮到什么东西的摩擦声，而不开空调室温到 30 度以上时，电源的风扇就会很响，于是也又拖朋友正好换了个 1200W 的酷冷至尊解决。

内存其实还算够用，但也属于是抠着在用了，这次因为上了可以用 ECC 的平台的话就决定把 NAS 系统的那部分变成 truenas，毕竟是在卖给企业卖系统的话稳定性什么的应该是不错的。而且也看到很多人都在吹 zfs 等等。那么现在 16T*4 的一个阵列的话官方推荐最好要配 64G 左右的系统内存，但我也有其他虚机需要用到，所以内存我先是分配的 48G 的。巧也是巧偶尔手贱在日拍上搜了一下 ECC 内存，发现有人在卖 32 *4 的 REG ECC 内存，叠上官方券价格和国内也差不多，而且国内问了几家闲鱼和淘宝还说缺货。那就拿下换上了，也是一次点亮。

所以整个配置只有机箱主板和 CPU 是当初店家给我的，后来全是我又花了好多钱买风扇改散热改电源的，也是一身汗。

### 软件配置

整体上沿用第一代的思想是底层 pve 然后加 truenas 来管理 nas 的文件，H11SSL 是带 IPMI 的主板，主板设置里设置成 optimal 就是消费级的自动了，但是不能拉曲线是比较麻烦，因为 p4 的显卡的温度是不会被 IPMI 给监控到的，因此风扇也是被控制的。因此要有一些工具进行一个读取 gpu 核心的温度然后进行程序化控制，我最后找到的是 smfc。

## 第 2.5 代 NAS 方案

所以之前掉盘原因其实应该是没有办法究明了，因为 B460M 主板被我卖了，系统我也装成了 windows，开机一个月也没有不能关机的问题。

## 附赠 算力机方案

## 一些实用小链接

> [CPU Benchmarks](https://www.cpubenchmark.net/CPU_mega_page.html) 用来查 CPU 评分 TDP等
